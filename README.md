# Demigras

----------------------------------------------------------------
## 名称について
本ソフトウェアの名称は「Demigras」とする。


### 語源
「DatabasE MIGRAtion Software」からの造語である。


### 読み
読みは「デミグラス」とする。
※なお、「デミグラスソース」のスペルは「Demi-glace sauce」であることに留意されたい。




----------------------------------------------------------------
## 機能について
本ソフトウェアは、下記の機能を有する。

- マイグレーション
    DCLやDMLの実行操作を意図した機能である。

- ロールバック
    マイグレーションの取消し操作を意図した機能である。

- シード
    マスタテーブル等へのデータ投入/変更/削除操作を意図した機能である。
    ※ファイルに変更があった場合には、DBに対して繰り返し適用される。

なお、それぞれの操作で実行するSQLは、利用するDBに則った形式のSQLで実装すること。


### 動作環境
PHP8.2以上がインストールされていること。


### 対応DB
PHPのPDOでサポートされるDBをサポートしている。
https://www.php.net/manual/ja/pdo.drivers.php




----------------------------------------------------------------
## コマンド
本ソフトウェアは、下記のコマンドで利用できる。


### マイグレーションファイルの生成
下記のコマンドで、マイグレーションファイルを生成する。
``` bash
demigras migration create [option]
```

#### オプション
本コマンドは、共通オプションに加えて、以下のオプションを指定できる。
|オプション名|値|備考|
|:--|:--|:--|
|--version|そのマイグレーションのバージョンを指定する。|1文字目を"V"(固定)とし、半角英数字・ドット(.)かつ、他のマイグレーションのVersion部と重複しない文字列で指定すること。|
|--remarks|そのマイグレーションの摘要を指定する。|半角英数字とアンダースコア(\_)のみで指定すること。|

#### 例
本コマンドの例を下記に示す。
``` bash
# 「V19700101000000-CreateSampleTbl.u.sql」のファイル名でマイグレーションファイルを生成するコマンド
demigras migration create --version="V19700101000000" --description="CreateSampleTbl"
```


### ロールバックファイルの生成
下記のコマンドで、ロールバックファイルを生成する。
``` bash
demigras rollback create [version] [option]
```

#### 引数
本コマンドには、下記の引数を指定しなければならない。
|引数名|値|備考|
|:--|:--|:--|
|version|ロールバック操作の対象となるマイグレーションのバージョンを指定する。|1文字目を"V"(固定)とし、半角英数字・ドット(.)かつ、他のロールバックのVersion部と重複しない文字列で指定すること。|

#### オプション
本コマンドは、共通オプションに加えて、以下のオプションを指定できる。
|オプション名|値|備考|
|:--|:--|:--|
|--remarks|そのロールバックの摘要を指定する。|半角英数字とアンダースコア(\_)のみで指定すること。|

#### 例
本コマンドの例を下記に示す。
``` bash
# 「V19700101000000-CreateSampleTbl.u.sql」のマイグレーションに対応するロールバックを生成するコマンド
demigras rollback create V19700101000000 --remarks="DropSampleTbl"
```


### シードファイルの生成
下記のコマンドで、シードファイルを生成する。
``` bash
demigras seed create [option]
```

#### オプション
本コマンドは、共通オプションに加えて、以下のオプションを指定できる。
|オプション名|値|備考|
|:--|:--|:--|
|--title|そのシードの摘要を指定する。|半角英数字とアンダースコア(\_)のみで指定すること。|
|--id|そのロールバックの摘要を指定する。|半角英数字のみかつ、他のシードのId部と重複しない文字列で指定すること。|

#### 例
本コマンドの例を下記に示す。
``` bash
# 「S-SampleSeed-F2ZF5UjoeNlZyzmv.sql」のファイル名でシードファイルを生成するコマンド
demigras seed create --title="SampleSeed" --id="F2ZF5UjoeNlZyzmv"
```


### マイグレーションの実行
下記のコマンドで、マイグレーションを実行する。
``` bash
demigras migration execute [option]
```

#### オプション
本コマンドは、共通オプションに加えて、以下のオプションを指定できる。
|オプション名|値|備考|
|:--|:--|:--|
|--steps|未実行のマイグレーションの内、実行するマイグレーションの最大数を指定する。|未指定の場合には、未実行の全てのマイグレーションを実行する。|

#### 例
本コマンドの例を下記に示す。
``` bash
# 最大5つの未実行のマイグレーションを実行するコマンド
demigras migration execute --steps=5
```


### ロールバックの実行
下記のコマンドで、ロールバックを実行する。
``` bash
demigras rollback execute [option]
```

#### オプション
本コマンドは、共通オプションに加えて、以下のオプションを指定できる。
|オプション名|値|備考|
|:--|:--|:--|
|--steps|実行済みのマイグレーションの内、ロールバックするマイグレーションの最大数を指定する。|指定しない場合、最後に実行されたマイグレーションのみをロールバックする。("1"を指定した場合と同義)|

#### 例
本コマンドの例を下記に示す。
``` bash
# 最大2つの実行済みのマイグレーションをロールバックするコマンド
demigras rollback execute --steps=2
```


### シードの実行
下記のコマンドで、シードを実行する。
``` bash
demigras seed execute [option]
```
未実行ないし、前回の実行から変更のあったシードファイルのみが実行される。

#### オプション
本コマンドは、共通オプションに加えて、以下のオプションを指定できる。
|オプション名|値|備考|
|:--|:--|:--|
|--all|値の指定は不要|実行状況に関わらず、すべてのシードファイルを実行する。|
|--file|実行するシードファイル名を指定する。||

#### 例
本コマンドの例を下記に示す。
``` bash
# 未実行・変更のあったシードファイルのみ実行
demigras seed execute

# すべてのシードファイルを実行
demigras seed execute --all

# 特定のシードファイルのみ実行
demigras seed execute --file="S-ExampleSeed-OgEO1PbocPXV84Li.sql"
```


### 共通オプション
本ソフトウェアのコマンドでは、下記のオプションを指定することができる。
|オプション名|値|備考|
|:--|:--|:--|
|--config|コンフィグファイルのパス|パスについてはカレントディレクトリを基準として相対パスで指定する。|




----------------------------------------------------------------
## 各機能のSQLファイルについて
各機能に関するSQLファイルは、下記の規則に基づいて作成すること。


### マイグレーション
マイグレーション機能に関するSQLファイルは、下記の規則に基づいて作成すること。

※`demigras migration create`コマンドの利用を推奨する。

#### 配置場所
設定ファイルで規定しない場合、下記のディレクトリに配置すること。
```
.demigras/migrations
```

#### 命名規則
下記の規則に基づいて命名すること。
```
[Version部]-[Remarks部].u.sql
```

##### Version部
1文字目を"V"(固定)とし、半角英数字・ドット(.)かつ、他のマイグレーションのVersion部と重複しない文字列で指定すること。

##### Remarks部
そのマイグレーションについての摘要を指定する。
半角英数字とアンダースコア(\_)のみで指定すること。

##### 例
ファイル名の例を下記に示す。
```
V19700101000000-Remarks.u.sql
```


### ロールバック
ロールバック機能に関するSQLファイルは、下記の規則に基づいて作成すること。

※`demigras rollback create`コマンドの利用を推奨する。

#### 配置場所
設定ファイルで規定しない場合、下記のディレクトリに配置すること。
```
.demigras/rollbacks
```

#### 命名規則
下記の規則に基づいて命名すること。
```
[Version部]-[Remarks部].r.sql
```

##### Version部
ロールバック操作に対応するマイグレーションのファイル名のVersion部と合致させかつ、他のロールバックのVersion部と重複しない文字列で指定すること。

##### Remarks部
そのロールバックについての摘要を指定する。
半角英数字とアンダースコア(\_)のみで指定すること。

##### 例
ファイル名の例を下記に示す。
```
V19700101000000-Remarks.r.sql
```


### シード
シード機能に関するSQLファイルは、下記の規則に基づいて作成すること。

※`demigras seed create`コマンドの利用を推奨する。

#### 配置場所
設定ファイルで規定しない場合、下記のディレクトリに配置すること。
```
.demigras/seeds
```

#### 命名規則
下記の規則に基づいて命名すること。
```
S-[Title部]-[Id部].sql
```

##### Title部
そのシードについての摘要を指定する。
半角英数字とアンダースコア(\_)のみで指定すること。

##### Id部
半角英数字のみかつ、他のシードのId部と重複しない文字列で指定すること。

##### 例
ファイル名の例を下記に示す。
```
S-Title-OgEO1PbocPXV84Li.sql
```




----------------------------------------------------------------
## 設定ファイル
本ソフトウェアの設定ファイルを下記の通り作成すること。


### 名称・配置場所について
原則としてファイル名を`.env`とし、プロジェクトのルートディレクトリに配置すること。

異なるファイル名・場所に設定ファイルを配置する場合には、各コマンドにおいて共通のオプション(`--config`)でファイル名を指定できる。

#### 例
設定ファイルを実行時に指定する場合の、コマンド例を下記に示す。
``` bash
migration someCommand --config=".migration/config"
```


### 項目について
設定ファイルには下記の項目を設定できる。

|項目名|必須|説明|
|:--|:--|:--|
|DEMIGRAS_DB_DSN|●|DBへの接続のためのDSNを指定する。書式については、PDOのマニュアルを参照のこと。|
|DEMIGRAS_DB_USER|-|DBのユーザ名を指定する。|
|DEMIGRAS_DB_PASSWORD|-|DBのパスワードを指定する。|
|DEMIGRAS_RESOURCE_DIR|-|本ソフトに関するファイルの保存場所を指定する。 Default:`.demigras`|
|DEMIGRAS_MIGRATIONS_DIR|-|マイグレーションファイルの保存場所を指定する。 Default:`${DEMIGRAS_RESOURCE_DIR}/migraions`|
|DEMIGRAS_ROLLBACKS_DIR|-|ロールバックファイルの保存場所を指定する。 Default:`${DEMIGRAS_RESOURCE_DIR}/rollbacks`|
|DEMIGRAS_SEEDS_DIR|-|シードファイルの保存場所を指定する。 Default:`${DEMIGRAS_RESOURCE_DIR}/seeds`|
